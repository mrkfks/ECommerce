@model List<ECommerce.Application.DTOs.UserDto>
@using ECommerce.Application.DTOs

@{
    ViewData["Title"] = "Kullanıcılar & Roller";
}

<div class="card shadow-sm border-0">
    <div class="card-header bg-white py-3 border-bottom">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0 text-primary fw-bold">Kullanıcı Listesi</h5>
            <a asp-action="Create" class="btn btn-primary btn-sm px-3">
                <i class="fa-solid fa-user-plus me-1"></i> Yeni Personel Ekle
            </a>
        </div>
        
        @if (User.IsInRole("SuperAdmin") && ViewBag.Companies != null)
        {
            <form method="get" asp-action="Index" class="row g-2">
                <div class="col-auto">
                    <label class="form-label mb-1 small">Şirkete Göre Filtrele:</label>
                </div>
                <div class="col-auto">
                    <select name="companyId" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="">Tüm Şirketler</option>
                        @foreach (var company in (List<CompanyDto>)ViewBag.Companies)
                        {
                            var isSelected = ViewBag.SelectedCompanyId == company.Id;
                            <option value="@company.Id" selected="@isSelected">
                                @company.Name
                            </option>
                        }
                    </select>
                </div>
                @if (ViewBag.SelectedCompanyId != null)
                {
                    <div class="col-auto">
                        <a asp-action="Index" class="btn btn-sm btn-outline-secondary">
                            <i class="fa-solid fa-times me-1"></i> Filtreyi Temizle
                        </a>
                    </div>
                }
            </form>
        }
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Ad Soyad</th>
                        <th>Kullanıcı Adı</th>
                        <th>Email</th>
                        <th>Şirket</th>
                        <th>Rol</th>
                        <th>Durum</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var user in Model)
                {
                    <tr>
                        <td>@user.Id</td>
                        <td>@user.FirstName @user.LastName</td>
                        <td>@user.Username</td>
                        <td>@user.Email</td>
                        <td>@(user.CompanyName ?? "-")</td>
                        <td>@string.Join(", ", user.Roles)</td>
                        <td>
                            @if (user.IsActive)
                            {
                                <span class="badge bg-success">Aktif</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">Pasif</span>
                            }
                        </td>
                        <td>
                            <a asp-action="Details" asp-route-id="@user.Id" class="btn btn-sm btn-info">Detay</a>
                            <a asp-action="Edit" asp-route-id="@user.Id" class="btn btn-sm btn-warning">Düzenle</a>
                            <button type="button" class="btn btn-sm btn-outline-dark" onclick="openRoleModal(@user.Id, '@user.Username', '@string.Join(",", user.Roles)')">
                                <i class="fa-solid fa-user-tag"></i> Rol
                            </button>
                            <a asp-action="Delete" asp-route-id="@user.Id" class="btn btn-sm btn-danger">Sil</a>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Rol Düzenleme Modal -->
<div class="modal fade" id="roleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-user-tag me-2"></i>Rol Yönetimi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Kullanıcı: <strong id="roleModalUsername"></strong></p>
                <input type="hidden" id="roleModalUserId">
                <div class="mb-3">
                    <label class="form-label">Roller</label>
                    <div id="roleCheckboxes">
                        @if (ViewBag.Roles != null)
                        {
                            foreach (var role in (List<string>)ViewBag.Roles)
                            {
                                <div class="form-check">
                                    <input class="form-check-input role-checkbox" type="checkbox" value="@role" id="role_@role">
                                    <label class="form-check-label" for="role_@role">
                                        @role
                                    </label>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" onclick="saveRoles()">
                    <i class="fa-solid fa-save me-1"></i> Kaydet
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    var roleModalElement = document.getElementById('roleModal');
    var roleModal = new bootstrap.Modal(roleModalElement);

    function openRoleModal(userId, username, currentRoles) {
        document.getElementById('roleModalUserId').value = userId;
        document.getElementById('roleModalUsername').textContent = username;
        
        // Tüm checkbox'ları temizle
        document.querySelectorAll('.role-checkbox').forEach(cb => cb.checked = false);
        
        // Mevcut rolleri işaretle
        if (currentRoles) {
            var rolesArray = currentRoles.split(',').map(r => r.trim());
            rolesArray.forEach(role => {
                var cb = document.getElementById('role_' + role);
                if (cb) cb.checked = true;
            });
        }
        
        roleModal.show();
    }

    async function saveRoles() {
        const userId = parseInt(document.getElementById('roleModalUserId').value);
        const roles = [];
        document.querySelectorAll('.role-checkbox:checked').forEach(cb => roles.push(cb.value));
        
        if (roles.length === 0) {
            alert('En az bir rol seçmelisiniz.');
            return;
        }
        
        try {
            const response = await fetch('/User/UpdateUserRoles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, roles })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Bir hata oluştu.');
        }
    }
</script>
}
