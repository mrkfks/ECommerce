@{
    ViewData["Title"] = "Dosya Yükle";
}

<div class="modal fade" id="imageUploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fa-solid fa-image me-2"></i> Resim Yükle
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="imageUploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="imageFile" class="form-label">Resim Seç (Birden fazla seçebilirsiniz)</label>
                        <input type="file" class="form-control" id="imageFile" name="file" accept="image/*" multiple required>
                        <small class="form-text text-muted d-block mt-2">
                            <i class="fa-solid fa-info-circle me-1"></i>
                            Desteklenen formatlar: JPG, PNG, GIF, WEBP (Maks: 5 MB her biri)
                        </small>
                    </div>
                    <div id="previewContainer" class="mb-3" style="display: none;">
                        <label class="form-label">Önizleme</label>
                        <div id="imagePreviewList" class="d-flex flex-wrap gap-2">
                            <!-- Önizlemeler buraya eklenecek -->
                        </div>
                    </div>
                    <div id="uploadProgress" class="progress" style="display: none;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="uploadBtn" onclick="uploadImage()">
                    <i class="fa-solid fa-upload me-2"></i> Yükle
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Resim seçildiğinde önizlemeleri göster
document.getElementById('imageFile').addEventListener('change', function(e) {
    const files = e.target.files;
    const previewList = document.getElementById('imagePreviewList');
    previewList.innerHTML = ''; // Önceki önizlemeleri temizle
    
    if (files.length > 0) {
        document.getElementById('previewContainer').style.display = 'block';
        
        Array.from(files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(event) {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'position-relative';
                imgDiv.innerHTML = `
                    <img src="${event.target.result}" alt="Önizleme ${index + 1}" 
                         style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #dee2e6;">
                    <span class="badge bg-primary position-absolute top-0 start-0 m-1">${index + 1}</span>
                `;
                previewList.appendChild(imgDiv);
            };
            reader.readAsDataURL(file);
        });
    }
});

async function uploadImage() {
    const fileInput = document.getElementById('imageFile');
    const files = fileInput.files;
    
    if (!files || files.length === 0) {
        alert('Lütfen en az bir resim seçin!');
        return;
    }

    const uploadUrl = document.getElementById('imageUploadForm').getAttribute('data-upload-url');
    if (!uploadUrl) {
        alert('Upload URL belirtilmedi!');
        return;
    }

    const progressBar = document.getElementById('progressBar');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadBtn = document.getElementById('uploadBtn');
    
    uploadProgress.style.display = 'block';
    uploadBtn.disabled = true;

    try {
        // Önce token al
        const tokenResponse = await fetch('/Auth/GetToken');
        if (!tokenResponse.ok) {
            throw new Error('Token alınamadı');
        }
        
        const tokenData = await tokenResponse.json();
        if (!tokenData.token) {
            throw new Error('Token boş döndü');
        }
        const token = tokenData.token;
        
        // Her dosyayı sırayla yükle
        let uploadedCount = 0;
        let lastImageUrl = '';
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const formData = new FormData();
            formData.append('file', file);
            
            progressBar.style.width = ((i / files.length) * 100) + '%';
            progressBar.textContent = `${i + 1}/${files.length} yükleniyor...`;
            
            const response = await fetch(uploadUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            
            if (!response.ok) {
                const text = await response.text();
                throw new Error(`Dosya ${i + 1} yüklenemedi: ${text}`);
            }
            
            const data = await response.json();
            if (data.success) {
                uploadedCount++;
                lastImageUrl = data.imageUrl;
            } else {
                throw new Error(data.message || `Dosya ${i + 1} yüklenemedi`);
            }
        }
        
        progressBar.style.width = '100%';
        progressBar.textContent = 'Tamamlandı!';
        alert(`${uploadedCount} resim başarıyla yüklendi!`);
        
        // Son yüklenen resmi göster
        if (window.imageUploadCallback && lastImageUrl) {
            window.imageUploadCallback(lastImageUrl);
        }
        
        // Modal'ı kapat
        const modal = bootstrap.Modal.getInstance(document.getElementById('imageUploadModal'));
        modal.hide();
        
        // Formu temizle
        fileInput.value = '';
        document.getElementById('previewContainer').style.display = 'none';
        document.getElementById('imagePreviewList').innerHTML = '';
        
    } catch (error) {
        console.error('Yükleme Hatası:', error);
        alert('Dosya yüklenirken hata oluştu:\n' + error.message);
    } finally {
        uploadProgress.style.display = 'none';
        progressBar.style.width = '0%';
        progressBar.textContent = '';
        uploadBtn.disabled = false;
    }
}

// Modal açılırken form'u temizle
document.getElementById('imageUploadModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('imageFile').value = '';
    document.getElementById('previewContainer').style.display = 'none';
    document.getElementById('imagePreviewList').innerHTML = '';
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressBar').textContent = '';
    document.getElementById('uploadBtn').disabled = false;
});
</script>
