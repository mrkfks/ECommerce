@model CampaignUpdateVm

@{
    ViewData["Title"] = "Kampanyayı Düzelt";
    var apiBaseUrl = ViewBag.ApiBaseUrl as string ?? "http://localhost:5010";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Kampanyayı Düzelt</h2>
            <p class="text-muted">Kampanya bilgilerini ve banner fotoğrafını güncelleyin</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form asp-action="Edit" method="post" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label asp-for="Name" class="form-label">Kampanya Adı *</label>
                            <input asp-for="Name" class="form-control" placeholder="Örn: Güz İndirimi" required>
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Description" class="form-label">Açıklama</label>
                            <textarea asp-for="Description" class="form-control" rows="3" placeholder="Kampanya hakkında bilgi girin"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="DiscountPercent" class="form-label">İndirim Yüzdesi (%) *</label>
                                    <div class="input-group">
                                        <input asp-for="DiscountPercent" type="number" step="0.01" min="0" max="100" class="form-control" placeholder="20" required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <span asp-validation-for="DiscountPercent" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="StartDate" class="form-label">Başlangıç Tarihi *</label>
                                    <input asp-for="StartDate" type="datetime-local" class="form-control" required>
                                    <span asp-validation-for="StartDate" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="EndDate" class="form-label">Bitiş Tarihi *</label>
                                    <input asp-for="EndDate" type="datetime-local" class="form-control" required>
                                    <span asp-validation-for="EndDate" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="BannerImageUrl" class="form-label">Banner Fotoğrafı</label>
                            <div id="dropZone" class="border-2 border-dashed border-secondary rounded p-4 text-center cursor-pointer mb-2" style="cursor: pointer; transition: all 0.3s;">
                                <i class="fas fa-cloud-upload-alt fa-3x text-secondary mb-2"></i>
                                <p class="mb-0">Fotoğraf sürükleyin veya tıklayın</p>
                                <small class="text-muted">JPG, PNG, WebP (Max: 5MB)</small>
                            </div>
                            <input type="file" id="bannerFile" name="bannerFile" class="form-control" accept="image/*" style="display: none;">
                            <div id="previewContainer" class="mt-3"></div>
                            <span asp-validation-for="BannerImageUrl" class="text-danger"></span>

                            @if (!string.IsNullOrEmpty(Model.BannerImageUrl))
                            {
                                <div class="mt-3 alert alert-info">
                                    <strong>Mevcut Banner:</strong>
                                    <div id="currentPreview" class="mt-2">
                                        <img src="@(Model.BannerImageUrl.StartsWith("http") ? Model.BannerImageUrl : $"{apiBaseUrl}{Model.BannerImageUrl}")" alt="Mevcut Banner" class="img-fluid rounded" style="max-width: 300px;">
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Değişiklikleri Kaydet
                            </button>
                            <a href="@Url.Action("Index")" class="btn btn-secondary">
                                <i class="fas fa-times"></i> İptal
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // File upload handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('bannerFile');
        const previewContainer = document.getElementById('previewContainer');
        const currentPreviewDiv = document.getElementById('currentPreview');
        const currentBannerUrl = currentPreviewDiv ? '@Model.BannerImageUrl' : null;

        // Click to upload
        dropZone.addEventListener('click', () => fileInput.click());

        // Drag and drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('bg-primary', 'bg-opacity-10');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('bg-primary', 'bg-opacity-10');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-primary', 'bg-opacity-10');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // Set the file to the input element
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(files[0]);
                fileInput.files = dataTransfer.files;
                handleFileSelection();
            }
        });

        fileInput.addEventListener('change', handleFileSelection);

        function handleFileSelection() {
            const file = fileInput.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Lütfen bir resim dosyası seçin');
                fileInput.value = '';
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('Dosya boyutu 5MB\'dan küçük olmalıdır');
                fileInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;

                // Show preview
                previewContainer.innerHTML = `
                    <div class="position-relative">
                        <img src="${dataUrl}" alt="Banner Preview" class="img-fluid rounded" style="max-width: 100%;">
                        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" onclick="clearPreview()">
                            <i class="fas fa-trash"></i> Temizle
                        </button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }

        function clearPreview() {
            fileInput.value = '';
            previewContainer.innerHTML = '';
        }
    </script>
}
